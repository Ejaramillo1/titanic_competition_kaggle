---
output:
  html_document:
    df_print: paged
---


# Sobrevivientes del Titanic parte I
## Análisis exploratorio

Los aspirantes a científicos de datos generalmente somos personas curiosas a las que les gusta navegar por internet buscando recursos que apoyen y consoliden nuestros conocimientos.

Un sitio muy popular donde se pueden encontrar mucha información sobre este tema es el sitio web **kaggle.com** en el que se desarrollan competencias entre personas apasionadas por los datos con el objetivo de generar los mejores modelos en función de las características particulares de cada conjunto de datos.

La base de datos del Titanic es uno de los primeros pasos para adentrarse en el mundo de la ciencia de datos desde el aprendizaje en ésta página **Kaggle** con muchos recursos a la mano. El objetivo de la base de datos y, la competencia es tratar de predecir si un pasajero sobrevive o no. 

Como en todos los ejercicios primero vamos a cargar los paquetes de funciones que se utilizarán en el ejercicio de estimación.


```{r warning=FALSE, message=FALSE}

library("easypackages")
my_packages <- c("tidyverse", "knitr")
libraries(my_packages)

```

Posteriormente vamos a subir la tabla de datos con la que trabajaremos

```{r warning=FALSE, message=FALSE}

train <- read_csv("train.csv")
test <- read_csv("test.csv")


```


Para no tener que hacer el proceso de limpieza dos veces vamos a unir las bases de datos train and test, así tendremos los mismos parámetros 



```{r}

test$Survived <- NA

all <- rbind(train, test)

```



Vamos a echar una ojeada a la tabla de datos para saber como están compuestas las variables. 


```{r warning=FALSE, message=FALSE}

glimpse(all)

```


Como podemos ver arriba, en nuestra tabla de datos hay doce variables de las cuales **Fare**, **Age** y **PassengerId**, las 9 variables más con de tipo categoricas sin embargo la variable **Pclass** está como un entero o variable numérica por lo que debemos recodificarla para obtener resultados satisfactorios. 

Una de las tareas principales al realizar análisis estadístico es conocer la base de datos y las relaciones entre las variables y también los valores perdidos. Para esto aplicaremos una función que nos ayudará a contar los valores perdidos en cada una de las columnas en nuestra tabla de datos. 

```{r warning=FALSE, message=FALSE}

sapply(all, function(x){sum(is.na(x))})

```


Según el conteo, las variables que tienen más valores perdidos son _Age_, _Cabin_ y _Embarked_. Confirmamos esto de manera gráfica con una función que nos ayuda a visualizar los valores perdidos de mejor manera. 



# Explorando algunas de las variables más importantes

```{r warning=FALSE, message=FALSE}

plot_Missing <- function(data_in, title = NULL){
  temp_df <- as.data.frame(ifelse(is.na(data_in), 0, 1))
  temp_df <- temp_df[,order(colSums(temp_df))]
  data_temp <- expand.grid(list(x = 1:nrow(temp_df), y = colnames(temp_df)))
  data_temp$m <- as.vector(as.matrix(temp_df))
  data_temp <- data.frame(x = unlist(data_temp$x), y = unlist(data_temp$y), m = unlist(data_temp$m))
  ggplot(data_temp) + geom_tile(aes(x=x, y=y, fill=factor(m))) + 
    scale_fill_manual(values=c("white", "black"), name="Missing\n(0=Yes, 1=No)") +
    theme_light() + ylab("") + xlab("") + ggtitle(title)
}


plot_Missing(all)


```



Confirmamos por lo tanto que las variables con mayor número de valores perdidos son la edad, la cabina y el lugar en el que se embarcaron, por otro lado la variable **Survived** muestra una gran cantidad de valores perdidos, esto se da principalmente por que unimos la tabla de datos de entrenamiento y de modelado.

## Exploración de la variable respuesta: Survived

Iniciamos la exploración de la tabla de datos analizando el comportamiento de la variable respuesta, en este caso de trata de una variable dicotómica que indica si la presona en cuestión sobrevivió o no.


```{r warning=FALSE, message=FALSE}

all %>%
  select(Sex, Survived, Pclass) %>%
  filter(!is.na(Survived)) %>%
  group_by(Survived, Sex) %>%
  summarise(n()) %>%
  ggplot(aes(x = factor(Survived) , y = `n()`)) +
  geom_bar(stat = "identity", aes(fill = factor(Survived))) +
  geom_label(aes(label = `n()`)) +
  facet_wrap(~Sex)


```

Vamos a ver ahora en qué clase viajaban una mayor cantidad de personas. 

```{r warning=FALSE, message=FALSE}

all %>%
  group_by(Pclass) %>%
  summarise(prcount = n()) %>%
  ggplot(aes(Pclass, prcount)) + 
  geom_bar(stat = "identity", aes(fill = factor(Pclass) )) + 
  geom_label(aes(label = prcount)) +
  theme_classic()

```

Observamos que la mayor cantidad de personas viajan en tercera clase. Superando sustancialmente a segunda y primera clase. 

Posteriormente 
```{r warning=FALSE, message=FALSE}

all %>%
  filter(!is.na(Survived)) %>%
  select(Sex, Survived, Pclass) %>% 
  group_by(Sex, Survived, Pclass) %>%
  summarise(prcount = n()) %>%
  arrange(desc(prcount)) %>%
  ggplot(aes(x = Sex, y = prcount)) + 
  geom_bar(stat = "identity", aes(fill = factor(Pclass))) +
  facet_grid(~Survived)

```

En la gráfica anterior mostramos otros datos interesantes que nos pueden dar luz acerca de la supervivencia al hundimiento. En ésta gráfica los colores representan el sexo, la división de las gráficas en tres partes representa la clase en la que viajaban los pasajeros, las barras que están encima del cero son los que no sobrevivieron  y las que están encima del uno son los que no sobrevivieron. 


Por ejemplo vamos a comparar las barras que se encuentran encima del número cero de color azúl, o sea hombres que no sobrevivieron. 

Vemos que la mayor cantidad de hombres que no sobrevivieron se encuentran en tercera clase luego segunda clase y al final primera clase. Los datos los observamos en la tabla de abajo. 

Del total de hombres que no sobrevivieron 300 viajaban en tercera clase, 91 en segunda clase y 77 en primera clase. Por lo que podemos inferir que debido a la gran diferencia entre las varaibles éste puede ser un predictor importante

```{r warning=FALSE, message=FALSE}

all %>%
  select(Sex, Survived, Pclass) %>%
  group_by(Sex, Survived, Pclass) %>%
  summarise(n()) %>%
  arrange(desc(`n()`)) %>%
  filter(Survived == 1) %>%
  spread(Pclass, `n()`) %>%
  rename(., 
         "Primera Clase" = `1` , "Segunda Clase" = `2`, "Tercera clase" = `3`) %>%
  ungroup() %>%
  select(-Survived) %>%
  kable()
```



Ahora que sucedió con las mujeres que no sobrevivieron de acuerdo a la clase en la que viajaban. 


```{r warning=FALSE, message=FALSE}

all %>%
  select(Sex, Survived, Pclass) %>%
  group_by(Sex, Survived, Pclass) %>%
  summarise(n()) %>%
  arrange(desc(`n()`)) %>%
  filter(Survived == 0)%>%
  spread(Pclass, `n()`) %>%
  rename(., 
         "Primera Clase" = `1` , "Segunda Clase" = `2`, "Tercera clase" = `3`) %>%
  ungroup() %>%
  select(-Survived) %>%
  kable()

```

Se observa que la mayor cantidad de mujeres que no sobrevivieron al accidente se encontraban en tercera clase, luego las que viajan en segunda y al final primera clase. Recordemos que una de las causas de la tragedia y a que las personas que sobrevivieron fueron tan pocas es por que no había suficientes barcos salvavidas. Lo que nos hace suponer que se les daba preferencia a las mujeres y, particularmente a las que viajaban en primera clase. 



```{r warning= FALSE, message=FALSE}

train %>%
  select(Sex, Survived, Pclass) %>%
  group_by(Sex, Survived, Pclass) %>%
  summarise(n()) %>%
  filter(Survived == 1) %>%
  arrange(desc(`n()`)) %>%
  kable()



```

De los sobrevivientes podemos observar que la mayor proporción es para mujeres en primera clase, posteriormente mujeres en tercera y al final mujeres en segunda clase. 

Los hombres la mayor cantidad de sobrevivientes son 47 que viajaban en tercera clase, 45 en primera y 17 en segunda. 


```{r warning= FALSE, message=FALSE}

train %>%
  select(Sex, Survived, Pclass) %>%
  group_by(Sex, Survived, Pclass) %>%
  summarise(n()) %>%
  filter(Survived == 0) %>%
  arrange(desc(`n()`)) %>%
  ggplot() +
  geom_bar(aes(x = Pclass, y = `n()`, fill = factor(Pclass)), stat = "identity") + 
  facet_wrap(~Sex)



```

El desarrollador del kernel que estamos siguiendo indica que, si bien se puede tratar como predictores separados el sexo y la clase, es una buena práctica unirlos  en una sola variable lo que nos dará una variable que 











Hasta ahora sólo hemos explorado las variables **Pclass**, **Survived** y **Sex** nos falta **Age**, **Fare**, **Cabin** como esta tabla de datos ya fue ampliamente explorada por diferenes analistas en la competencia de Kaggle una de las recomendaciones en uno de los kernels creado por **Erick Bruin**, otra modificación que normamente se le realiza al dataset es extraer el título de la persona que viajaba, 

```{r warning= FALSE, message=FALSE}


train <- train %>%
  mutate(pr = factor(if_else(.$Pclass == '1' & .$Sex == 'male',"P1Male", 
                      if_else(.$Pclass == '2' & .$Sex == 'male', "P2Male", 
                              if_else(.$Pclass == '3' & .$Sex == 'male', "P3Male",
                                      if_else(.$Pclass == 1 & .$Sex == 'female', "P1Female", 
                                              if_else(.$Pclass == 2 & .$Sex == 'female', "P2Female", 
                                                      if_else(.$Pclass == 3 & .$Sex == "female", "P3Female", "na"))))))),
         title = gsub('(.*,)|(\\..*)', '', .$Name))

table(train$Sex, train$title)

```





En la gráfica anterior observamos diferentes cosas pero primero tenemos que explicar cómo se lee. 

1. Los colores representan si la persona sobrevivió o no, Es rojo si la persona **no sobrevivió** y azúl si la persona **sobrevivió**

2. La gráfica está dividida en dos, del lado derecho están las mujeres y del lado izquierdo los hombres.

Por ejemplo observamos que del lado derecho la barra de color rojo muestra el número 81 y del lado izquierdo muestra 468. Esto quiere decir que, de acuerdo con los datos que tenemos en la tabla test 81 mujeres murieron contra 468 hombres. Esto nos muestra que la variable sexo es un predictor importante debido a la tasa desproporcionada de supervivencia deacuerdo al sexo.

Ahora vamos a proseguir con una inspección gráfica de las variables cuantitativas, que son la **Edad (AGE)**  y la **Tarifa (Fare)** 

```{r warning=FALSE, message=FALSE}

all %>%
  keep(is.numeric) %>%
  select(Age, Fare) %>%
  gather() %>%
  ggplot(aes(x = value, fill = "red")) + 
  facet_wrap(~key, scales = "free") +
  geom_density()

```

Podemos ver por ejemplo que la edad tiene una distribución casi normal con un sezgo positivo, adicionalmente observamos que la tarifa está sezgada hacia la derecha. Observamos también que las variables tienen algunos datos atípicos principalmente la variable **_fare_**.

```{r warning=FALSE, message=FALSE} 

train %>%
  keep(is.numeric) %>%
  select(Age, Fare, Pclass) %>%
  mutate(Age = scale(Age),
         Fare = scale(Fare)) %>%
  gather(key = "key", value = "value", -Pclass) %>%
  ggplot(aes(x= value, fill = factor(Pclass))) +
  geom_density() +
  facet_wrap(~key, scales = "free")  +
  theme_classic()


```

Podemos observar que la variable edad tiene un comportamiento casi normal con algunas exepciones o casos atípicos de personas de avanzada edad. La variable que tiene mayores problemas es Fare. Se observa en el histograma que no tiene un comportamiento normal debido a ciertas variables atípicas. Vamos a confirmar esto con un diagrama de hoja y bigotes que nos permite visualizar de mejor manera las observaciones atípicas. 

```{r warning=FALSE, message=FALSE} 

train %>%
  keep(is.numeric) %>%
  select(Age, Fare, Pclass) %>%
  mutate(Age = scale(Age),
         Fare = scale(Fare)) %>%
  gather(key = "key", value = "value", -Pclass) %>%
  ggplot(aes(y=value, fill = factor(Pclass))) +
  facet_wrap(~key, scales = "free") +
  geom_boxplot()+
  theme_classic()


```


Las dos gráficas de caja y bigotes para las variables **Age** y **Fare** se observa que el ticket en primera clase es en promedio más alto que en las dos clases. En tercera clase tenemos algunos tickets que superan el promedio de primera clase. Así mismo observamos un dato importante, en promedio las personas viajando en primera clase son de mayor edad que las de segunda y tercera clase. 


Suponemos que la variable Fare está relacionada con la clase donde viajan los pasajeros, por lo que vamos a observar los valores mínimos, máximos y desviación estándar de las variables. 


```{r warning=FALSE, message=FALSE}

train %>%
  filter(Fare != 0) %>%
  group_by(Pclass) %>%
  summarise(max = max(Fare, na.rm = TRUE), media = mean(Fare, na.rm = TRUE), min = min(Fare, na.rm = TRUE), sd = sd(Fare, na.rm = TRUE)) %>%
  gather(estadistico, valor, -Pclass) %>%
  ggplot(aes(x = estadistico, y = valor, colour = factor(Pclass))) +
  geom_point(stat = "identity", position = "stack") + 
  theme_classic()



```

Observamos en la grafica de arriba que:

* El valor máximo pagado por los boletos es sustancialmente diferente cuando comparamos por clase.

* La diferencia del precio promedio de los boletos es mayor entre primera clase. Segunda y tercera clase la diferencia no es tan grande. 

Hasta ahora hemos observado varias características significativas en las variables que hemos analizado

1. La distribución de la edad entre los pasajeros tiene una distribución casi normal sin embargo hay un pequeño salto en la cantidad de menores que viajan

2. Las personas que viajan en tercera clase son las que tienen una distribución mas normal, las personas viajando en primera clase son en promedio de mayor edad


3. En promedio la tarifa pagada por las personas viajando en primera clase es mayor. Sin embargo tienen una distribución más sezgada y con valores atípicos. 














